"""
Playwright Test Generator for Phase 5 - Visual UX Evaluation

This module generates Playwright test code for key user flows, enabling
automated visual testing and screenshot capture.

Features:
- Generates Playwright test scripts based on user flow definitions
- Includes screenshot capture at each step
- Supports multiple flows (onboarding, dashboard, settings, checkout, etc.)
- Configurable test generation with customizable selectors and actions
"""

from dataclasses import dataclass, field
from typing import List, Dict, Optional, Literal
from pathlib import Path
import json


ActionType = Literal["navigate", "click", "fill", "select", "wait", "screenshot", "assert_text", "assert_visible"]


@dataclass
class TestStep:
    """Represents a single step in a Playwright test."""
    action: ActionType
    description: str
    selector: Optional[str] = None
    value: Optional[str] = None
    timeout: Optional[int] = 5000
    screenshot_name: Optional[str] = None

    def to_dict(self) -> Dict:
        """Convert to dictionary representation."""
        return {
            "action": self.action,
            "description": self.description,
            "selector": self.selector,
            "value": self.value,
            "timeout": self.timeout,
            "screenshot_name": self.screenshot_name
        }

    @classmethod
    def from_dict(cls, data: Dict) -> "TestStep":
        """Create TestStep from dictionary."""
        return cls(**data)


@dataclass
class UserFlow:
    """Represents a complete user flow with multiple test steps."""
    flow_id: str
    name: str
    description: str
    steps: List[TestStep] = field(default_factory=list)
    viewport: Dict[str, int] = field(default_factory=lambda: {"width": 1920, "height": 1080})
    base_url: str = "http://localhost:3000"

    def add_step(self, step: TestStep) -> None:
        """Add a test step to this flow."""
        self.steps.append(step)

    def to_dict(self) -> Dict:
        """Convert to dictionary representation."""
        return {
            "flow_id": self.flow_id,
            "name": self.name,
            "description": self.description,
            "steps": [step.to_dict() for step in self.steps],
            "viewport": self.viewport,
            "base_url": self.base_url
        }

    @classmethod
    def from_dict(cls, data: Dict) -> "UserFlow":
        """Create UserFlow from dictionary."""
        steps = [TestStep.from_dict(s) for s in data.get("steps", [])]
        return cls(
            flow_id=data["flow_id"],
            name=data["name"],
            description=data["description"],
            steps=steps,
            viewport=data.get("viewport", {"width": 1920, "height": 1080}),
            base_url=data.get("base_url", "http://localhost:3000")
        )


class PlaywrightTestGenerator:
    """Generates Playwright test code from user flow definitions."""

    def __init__(self, output_dir: Path = Path("tests/ux_flows")):
        """
        Initialize the Playwright test generator.

        Args:
            output_dir: Directory where test files will be generated
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)

    def generate_test_code(self, flow: UserFlow) -> str:
        """
        Generate Playwright test code for a user flow.

        Args:
            flow: UserFlow definition

        Returns:
            Generated Python test code as string
        """
        test_code = self._generate_header(flow)
        test_code += self._generate_test_function(flow)
        return test_code

    def _generate_header(self, flow: UserFlow) -> str:
        """Generate test file header with imports."""
        return f'''"""
{flow.name} - Playwright Test

{flow.description}

Auto-generated by PlaywrightTestGenerator
"""

from playwright.sync_api import Page, expect
from pathlib import Path


'''

    def _generate_test_function(self, flow: UserFlow) -> str:
        """Generate the main test function."""
        func_name = flow.flow_id.replace("-", "_")

        code = f'''def test_{func_name}(page: Page) -> None:
    """
    Test: {flow.name}

    {flow.description}
    """
    # Set viewport
    page.set_viewport_size({{"width": {flow.viewport["width"]}, "height": {flow.viewport["height"]}}})

    # Create screenshots directory
    screenshots_dir = Path("screenshots/{flow.flow_id}")
    screenshots_dir.mkdir(parents=True, exist_ok=True)

'''

        # Generate code for each step
        for i, step in enumerate(flow.steps, 1):
            code += f"    # Step {i}: {step.description}\n"
            code += self._generate_step_code(step, flow.flow_id)
            code += "\n"

        return code

    def _generate_step_code(self, step: TestStep, flow_id: str) -> str:
        """Generate code for a single test step."""
        code = ""

        if step.action == "navigate":
            code += f'    page.goto("{step.value}")\n'

        elif step.action == "click":
            code += f'    page.click("{step.selector}")\n'

        elif step.action == "fill":
            code += f'    page.fill("{step.selector}", "{step.value}")\n'

        elif step.action == "select":
            code += f'    page.select_option("{step.selector}", "{step.value}")\n'

        elif step.action == "wait":
            if step.selector:
                code += f'    page.wait_for_selector("{step.selector}", timeout={step.timeout})\n'
            else:
                code += f'    page.wait_for_timeout({step.timeout})\n'

        elif step.action == "screenshot":
            screenshot_name = step.screenshot_name or "screenshot"
            code += f'    page.screenshot(path=screenshots_dir / "{screenshot_name}.png", full_page=True)\n'

        elif step.action == "assert_text":
            code += f'    expect(page.locator("{step.selector}")).to_contain_text("{step.value}")\n'

        elif step.action == "assert_visible":
            code += f'    expect(page.locator("{step.selector}")).to_be_visible()\n'

        return code

    def save_test(self, flow: UserFlow) -> Path:
        """
        Generate and save a Playwright test file.

        Args:
            flow: UserFlow definition

        Returns:
            Path to the generated test file
        """
        test_code = self.generate_test_code(flow)
        test_file = self.output_dir / f"test_{flow.flow_id.replace('-', '_')}.py"
        test_file.write_text(test_code)
        return test_file

    def save_flow_definition(self, flow: UserFlow) -> Path:
        """
        Save flow definition as JSON for later reference.

        Args:
            flow: UserFlow definition

        Returns:
            Path to the saved JSON file
        """
        json_file = self.output_dir / f"{flow.flow_id}.json"
        with open(json_file, 'w') as f:
            json.dump(flow.to_dict(), f, indent=2)
        return json_file

    def load_flow_definition(self, flow_id: str) -> UserFlow:
        """
        Load a flow definition from JSON file.

        Args:
            flow_id: ID of the flow to load

        Returns:
            UserFlow instance
        """
        json_file = self.output_dir / f"{flow_id}.json"
        with open(json_file, 'r') as f:
            data = json.load(f)
        return UserFlow.from_dict(data)

    def generate_all_tests(self, flows: List[UserFlow]) -> List[Path]:
        """
        Generate test files for multiple flows.

        Args:
            flows: List of UserFlow definitions

        Returns:
            List of paths to generated test files
        """
        test_files = []
        for flow in flows:
            test_file = self.save_test(flow)
            self.save_flow_definition(flow)
            test_files.append(test_file)
        return test_files


def create_default_onboarding_flow() -> UserFlow:
    """Create a default onboarding flow for testing."""
    flow = UserFlow(
        flow_id="onboarding",
        name="User Onboarding Flow",
        description="Tests the complete user onboarding experience from landing page to dashboard"
    )

    flow.add_step(TestStep(
        action="navigate",
        description="Navigate to landing page",
        value="http://localhost:3000"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture landing page",
        screenshot_name="step1_landing"
    ))

    flow.add_step(TestStep(
        action="click",
        description="Click Get Started button",
        selector="button:text('Get Started')"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture signup form",
        screenshot_name="step2_signup"
    ))

    flow.add_step(TestStep(
        action="fill",
        description="Enter email",
        selector="input[name='email']",
        value="test@example.com"
    ))

    flow.add_step(TestStep(
        action="fill",
        description="Enter password",
        selector="input[name='password']",
        value="SecurePassword123!"
    ))

    flow.add_step(TestStep(
        action="click",
        description="Submit signup form",
        selector="button[type='submit']"
    ))

    flow.add_step(TestStep(
        action="wait",
        description="Wait for dashboard to load",
        selector="h1:text('Dashboard')"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture dashboard",
        screenshot_name="step3_dashboard"
    ))

    flow.add_step(TestStep(
        action="assert_visible",
        description="Verify welcome message",
        selector="text='Welcome'"
    ))

    return flow


def create_default_dashboard_flow() -> UserFlow:
    """Create a default dashboard navigation flow."""
    flow = UserFlow(
        flow_id="dashboard-navigation",
        name="Dashboard Navigation Flow",
        description="Tests navigation through main dashboard sections"
    )

    flow.add_step(TestStep(
        action="navigate",
        description="Navigate to dashboard",
        value="http://localhost:3000/dashboard"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture main dashboard",
        screenshot_name="step1_main"
    ))

    flow.add_step(TestStep(
        action="click",
        description="Navigate to Projects",
        selector="a:text('Projects')"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture projects page",
        screenshot_name="step2_projects"
    ))

    flow.add_step(TestStep(
        action="click",
        description="Navigate to Settings",
        selector="a:text('Settings')"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture settings page",
        screenshot_name="step3_settings"
    ))

    return flow


def create_default_settings_flow() -> UserFlow:
    """Create a default settings configuration flow."""
    flow = UserFlow(
        flow_id="settings",
        name="Settings Configuration Flow",
        description="Tests updating user preferences in settings"
    )

    flow.add_step(TestStep(
        action="navigate",
        description="Navigate to settings",
        value="http://localhost:3000/settings"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture settings page",
        screenshot_name="step1_settings"
    ))

    flow.add_step(TestStep(
        action="fill",
        description="Update display name",
        selector="input[name='displayName']",
        value="Test User"
    ))

    flow.add_step(TestStep(
        action="select",
        description="Change theme",
        selector="select[name='theme']",
        value="dark"
    ))

    flow.add_step(TestStep(
        action="click",
        description="Save changes",
        selector="button:text('Save Changes')"
    ))

    flow.add_step(TestStep(
        action="wait",
        description="Wait for success message",
        selector="text='Settings saved successfully'"
    ))

    flow.add_step(TestStep(
        action="screenshot",
        description="Capture success state",
        screenshot_name="step2_saved"
    ))

    return flow
